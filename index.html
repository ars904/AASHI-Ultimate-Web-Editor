<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AASHI Ultimate Web Editor</title>
  <!-- Use a specific Prism theme -->
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.css" rel="stylesheet" id="theme-style" />
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg: #1e1e1e;
      --fg: #ffffff;
      --accent: #007acc;
      --editor-bg: #252526;
      --toolbar-bg: #333;
      --tab-bg: #2d2d2d;
      --border: #444;
      --preview-bg: #ffffff;
      --preview-fg: #000000;
      --button-hover: #3a3a3a;
      --button-active: #4a4a4a;
      --suggestion-bg: #333;
      --suggestion-hover: #007acc;
    }
    body.light {
      --bg: #f5f5f5;
      --fg: #333333;
      --accent: #007acc;
      --editor-bg: #ffffff;
      --toolbar-bg: #e0e0e0;
      --tab-bg: #f0f0f0;
      --border: #ddd;
      --preview-bg: #ffffff;
      --preview-fg: #000000;
      --button-hover: #e5e5e5;
      --button-active: #d5d5d5;
      --suggestion-bg: #f0f0f0;
      --suggestion-hover: #007acc;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
      background-color: var(--bg);
      color: var(--fg);
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    .app-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .preview-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: var(--preview-bg);
      color: var(--preview-fg);
      border-right: 1px solid var(--border);
      position: relative;
    }
    .preview-header {
      padding: 10px 15px;
      background-color: var(--toolbar-bg);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .preview-header i {
      color: var(--accent);
    }
    iframe {
      flex: 1;
      border: none;
      background-color: var(--preview-bg);
    }
    .editor-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .toolbar {
      background: var(--toolbar-bg);
      padding: 8px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }
    .toolbar-button {
      padding: 6px 12px;
      background-color: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background-color 0.2s;
    }
    .toolbar-button:hover {
      background-color: #006bb3;
    }
    .toolbar-button.secondary {
      background-color: transparent;
      color: var(--fg);
      border: 1px solid var(--border);
    }
    .toolbar-button.secondary:hover {
      background-color: var(--button-hover);
    }
    .toolbar-button.secondary:active {
      background-color: var(--button-active);
    }
    .tabs {
      display: flex;
      background: var(--tab-bg);
      flex-shrink: 0;
      border-bottom: 1px solid var(--border);
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      color: var(--fg);
      font-size: 14px;
      font-weight: 500;
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tab.active {
      background: var(--editor-bg);
      color: var(--accent);
    }
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background-color: var(--accent);
    }
    .tab i {
      font-size: 14px;
    }
    .code-wrapper {
      flex: 1;
      overflow: hidden;
      background: var(--editor-bg);
      position: relative;
    }
    .editor {
      width: 100%;
      height: 100%;
      font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
      font-size: 14px;
      line-height: 1.5;
      background: var(--editor-bg);
      color: var(--fg);
      outline: none;
      caret-color: var(--fg);
      padding: 15px;
      box-sizing: border-box;
      tab-size: 2;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: break-word;
    }
    .editor span {
      caret-color: var(--fg);
    }
    .suggestions {
      position: absolute;
      background: var(--suggestion-bg);
      border: 1px solid var(--border);
      color: var(--fg);
      font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
      font-size: 14px;
      display: none;
      z-index: 999;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      border-radius: 4px;
    }
    .suggestions div {
      padding: 8px 12px;
      cursor: pointer;
    }
    .suggestions div:hover,
    .suggestions div.selected {
      background: var(--suggestion-hover);
      color: white;
    }
    .color-picker {
      display: none;
      position: absolute;
      z-index: 999;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    input[type="file"] {
      display: none;
    }
    .resize-handle {
      width: 8px;
      background-color: var(--border);
      cursor: col-resize;
      transition: background-color 0.2s;
    }
    .resize-handle:hover {
      background-color: var(--accent);
    }
    .status-bar {
      background-color: var(--toolbar-bg);
      padding: 4px 12px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
    }
    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
      }
      .preview-container {
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
      .resize-handle {
        width: 100%;
        height: 8px;
        cursor: row-resize;
      }
    }
  </style>
</head>
<body>

     <div class="app-container">
     <div class="editor-container">
      <div class="toolbar">
        <button class="toolbar-button" onclick="runCode()">
          <i class="fas fa-play"></i>
          <span>Run</span>
        </button>
        <button class="toolbar-button secondary" onclick="saveProject()">
          <i class="fas fa-save"></i>
          <span>Save</span>
        </button>
        <label for="fileInput" class="toolbar-button secondary">
          <i class="fas fa-folder-open"></i>
          <span>Load</span>
        </label>
        <input type="file" id="fileInput" multiple accept=".html,.css,.js,.md,.json">

        <div style="flex: 1;"></div>
        <button class="toolbar-button secondary" onclick="toggleTheme()">
          <i class="fas fa-moon"></i>
          <span>Theme</span>
        </button>
      </div>
              
      <div class="tabs">
        <div class="tab active" onclick="switchTab('html')">
          <i class="fab fa-html5"></i>
          <span>HTML</span>
        </div>
        <div class="tab" onclick="switchTab('css')">
          <i class="fab fa-css3-alt"></i>
          <span>CSS</span>
        </div>
        <div class="tab" onclick="switchTab('js')">
          <i class="fab fa-js-square"></i>
          <span>JavaScript</span>
        </div>
        <div class="tab" onclick="switchTab('md')">
          <i class="fas fa-markdown"></i>
          <span>Markdown</span>
        </div>
      </div>

      <div class="code-wrapper">
        <pre id="code" class="editor language-html" contenteditable="true" spellcheck="false"></pre>
        <div id="suggestions" class="suggestions"></div>
        <input type="color" id="colorPicker" class="color-picker" oninput="applyColor()" />
      </div>
      
      <div class="status-bar">
        <div class="status-item">
          <i class="fas fa-code"></i>
          <span id="currentLang">HTML</span>
        </div>
        <div class="status-item">
          <i class="fas fa-keyboard"></i>
          <span id="lineCol">Ln 1, Col 1</span>
        </div>
      </div>
    </div> 
     <div class="resize-handle" id="resizeHandle"></div>
    <div class="app-container">
    <div class="preview-container">
      <div class="preview-header">
        <i class="fas fa-eye"></i>
        <span>Preview</span>
      </div>
      <iframe id="preview"></iframe>
    </div>
  </div>
         

  <!-- Prism Core FIRST -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
  <!-- Prism Dependencies (CLike needed for JS, Markup needed for HTML/MD) -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-clike.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markup.min.js"></script>
  <!-- Prism Languages -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-css.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markdown.min.js"></script>
  <!-- Other libraries -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    // --- DOM Elements ---
    const codeEl = document.getElementById("code");
    const previewEl = document.getElementById("preview");
    const colorPicker = document.getElementById("colorPicker");
    const suggestionsBox = document.getElementById("suggestions");
    const tabs = document.querySelectorAll(".tab");
    const themeStyle = document.getElementById("theme-style");
    const resizeHandle = document.getElementById("resizeHandle");
    const currentLangDisplay = document.getElementById("currentLang");
    const lineColDisplay = document.getElementById("lineCol");

    // --- State ---
    let currentTab = "html";
    let currentCode = { html: '', css: '', js: '', md: '' };
    let colorPickerTargetRange = null;
    let isResizing = false;
    let lastX, lastY;

    // --- Keywords for Suggestions ---
    const keywords = {
  html: ["<!DOCTYPE html>", "<html>", "<head>", "<title>", "<body>", "<div>", "<span>", "<p>", "<h1>", "<h2>", "<h3>", "<h4>", "<h5>", "<h6>", "<img>", "<a>", "<button>", "<input>", "<textarea>", "<ul>", "<ol>", "<li>", "<form>", "<script>", "<style>", "<link>", "<meta>", "<header>", "<footer>", "<nav>", "<main>", "<section>", "<article>", "<aside>"],
  css: ["color", "background", "background-color", "margin", "padding", "border", "border-radius", "font-size", "font-family", "font-weight", "text-align", "display", "position", "width", "height", "z-index", "opacity", "flex", "grid", "align-items", "justify-content", "transition", "animation", "@media", "@keyframes", "transform", "box-shadow", "text-shadow"],
  js: ["function", "let", "const", "var", "if", "else", "for", "while", "do", "switch", "case", "break", "continue", "return", "class", "extends", "super", "constructor", "async", "await", "try", "catch", "finally", "throw", "import", "export", "default", "console.log", "document", "window", "getElementById", "querySelector", "querySelectorAll", "addEventListener", "createElement", "appendChild", "innerHTML", "style", "classList", "Math", "Date", "Array", "Object", "String", "Number", "Boolean", "null", "undefined", "true", "false", "=>", "this", "new", "setTimeout", "setInterval", "fetch", "JSON", "localStorage"],
  md: ["#", "##", "###", "####", "#####", "######", "*", "_", "**", "__", "`", "```", "- ", "+ ", "1. ", "[", "](", "!", "![", "](", "> ", "|", "---", "`", "```javascript", "```html", "```css"]
};

    // --- Initialization ---
    window.onload = () => {
      // Load theme preference
      const savedTheme = localStorage.getItem("theme") || "dark";
      if (savedTheme === "light") {
        document.body.classList.add("light");
        themeStyle.href = "https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css";
      } else {
        themeStyle.href = "https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.css";
      }

      // Load code from localStorage
      loadCodeFromStorage();

      // Set initial tab
      switchTab(currentTab);
      
      // Initialize resize handle
      setupResizeHandle();
      
      // Update cursor position initially
      updateCursorPosition();
    };

    // --- Event Listeners ---
    codeEl.addEventListener("input", handleInput);
    codeEl.addEventListener("keydown", handleKeydown);
    codeEl.addEventListener("click", hideSuggestions);
    codeEl.addEventListener("blur", hideSuggestions);
    codeEl.addEventListener("keyup", updateCursorPosition);
    codeEl.addEventListener("click", updateCursorPosition);

    // --- Core Functions ---

    function handleInput() {
        currentCode[currentTab] = codeEl.innerText;
        localStorage.setItem(`code-${currentTab}`, currentCode[currentTab]);
        highlightCurrentElement();
        showSuggestions();
        
        if (currentTab === 'css') {
            detectColorCode();
        } else {
            hideColorPicker();
        }
        
        updateCursorPosition();
    }

    function handleKeydown(e) {
      // Handle suggestion navigation/selection
      if (suggestionsBox.style.display === "block") {
        const items = suggestionsBox.querySelectorAll("div");
        let currentIdx = -1;
        items.forEach((item, idx) => {
          if (item.classList.contains("selected")) {
            currentIdx = idx;
          }
        });

        if (e.key === "ArrowDown") {
          e.preventDefault();
          if (currentIdx < items.length - 1) {
            if (currentIdx !== -1) items[currentIdx].classList.remove("selected");
            items[currentIdx + 1].classList.add("selected");
            items[currentIdx + 1].scrollIntoView({ block: "nearest" });
          }
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          if (currentIdx > 0) {
            items[currentIdx].classList.remove("selected");
            items[currentIdx - 1].classList.add("selected");
            items[currentIdx - 1].scrollIntoView({ block: "nearest" });
          }
        } else if (e.key === "Enter" || e.key === "Tab") {
          if (currentIdx !== -1) {
            e.preventDefault();
            items[currentIdx].click();
            hideSuggestions();
          } else {
             hideSuggestions();
          }
        } else if (e.key === "Escape") {
           e.preventDefault();
           hideSuggestions();
        }
      } else if (e.key === "Tab") {
          e.preventDefault();
          const sel = window.getSelection();
          const range = sel.getRangeAt(0);
          const tabNode = document.createTextNode("  ");
          range.insertNode(tabNode);
          range.setStartAfter(tabNode);
          range.setEndAfter(tabNode);
          sel.removeAllRanges();
          sel.addRange(range);
          handleInput();
      }

      if (e.key === "Escape") {
         hideColorPicker();
      }
      
      updateCursorPosition();
    }

    function switchTab(lang, skipSave = false) {
  if (!skipSave) {
    currentCode[currentTab] = codeEl.innerText;
    localStorage.setItem(`code-${currentTab}`, currentCode[currentTab]);
  }

  currentTab = lang;
  tabs.forEach(tab => tab.classList.remove("active"));
  const targetTab = Array.from(tabs).find(tab => tab.getAttribute('onclick')?.includes(`switchTab('${lang}')`));
  if (targetTab) targetTab.classList.add("active");

  codeEl.className = `editor language-${lang === "md" ? "markdown" : lang}`;
  codeEl.innerText = currentCode[lang] || getDefaultCode(lang);

  currentLangDisplay.textContent =
    lang === 'html' ? 'HTML' :
    lang === 'css' ? 'CSS' :
    lang === 'js' ? 'JavaScript' : 'Markdown';

  highlightCurrentElement();
  hideSuggestions();
  hideColorPicker();
  updateCursorPosition();
}

    function highlightCurrentElement() {
      const selection = window.getSelection();
      let caretPosition = null;
      if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          caretPosition = {
              startContainer: range.startContainer,
              startOffset: range.startOffset,
              endContainer: range.endContainer,
              endOffset: range.endOffset
          };
      }

      Prism.highlightElement(codeEl);

      if (caretPosition && codeEl.contains(caretPosition.startContainer) && codeEl.contains(caretPosition.endContainer)) {
          const newRange = document.createRange();
          try {
              if (caretPosition.startOffset <= (caretPosition.startContainer.length || 0) &&
                  caretPosition.endOffset <= (caretPosition.endContainer.length || 0) )
              {
                  newRange.setStart(caretPosition.startContainer, caretPosition.startOffset);
                  newRange.setEnd(caretPosition.endContainer, caretPosition.endOffset);
                  selection.removeAllRanges();
                  selection.addRange(newRange);
              }
          } catch (e) {
              console.warn("Could not restore caret position after highlighting.", e);
              codeEl.focus();
              const range = document.createRange();
              range.selectNodeContents(codeEl);
              range.collapse(false);
              selection.removeAllRanges();
              selection.addRange(range);
          }
      } else if (caretPosition) {
          codeEl.focus();
          const range = document.createRange();
          range.selectNodeContents(codeEl);
          range.collapse(false);
          selection.removeAllRanges();
          selection.addRange(range);
      }
    }

    function getDefaultCode(lang) {
      const samples = {
        html: `<!DOCTYPE html>
<html>
<head>
    <title>My Page</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Hello AASHI</h1>
    <p>Welcome to the AASHI Ultimate Web Editor!</p>
    <button id="myButton">Click Me</button>
    <script src="script.js"><\/script>
</body>
</html>`,
        css: `body {
  font-family: 'Segoe UI', sans-serif;
  background-color: #f5f5f5;
  color: #333;
  line-height: 1.6;
  padding: 2rem;
  max-width: 1200px;
  margin: 0 auto;
}

h1 {
  color: #007acc;
  border-bottom: 2px solid #007acc;
  padding-bottom: 0.5rem;
}

button {
  background-color: #007acc;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.2s;
}

button:hover {
  background-color: #006bb3;
}`,
        js: `// JavaScript code goes here
document.addEventListener('DOMContentLoaded', function() {
  const button = document.getElementById('myButton');
  
  button.addEventListener('click', function() {
    alert('Button clicked!');
    console.log('Button was clicked at ' + new Date());
  });
  
  // Modern ES6+ features
  const greet = (name) => \`Hello, \${name}!\`;
  console.log(greet('Developer'));
});`,
        md: `# Welcome to Markdown Editor

This is a **modern** markdown editor with *live preview*.

## Features
- Real-time rendering
- Syntax highlighting
- Multiple themes
- Code suggestions

\`\`\`javascript
// Code blocks are supported
function hello() {
  console.log("Hello, Markdown!");
}
\`\`\`

> Tip: Click the Run button to see the rendered output.

[Learn more about Markdown](https://www.markdownguide.org)`
      };
      currentCode[lang] = samples[lang];
      return samples[lang] || '';
    }

    function loadCodeFromStorage() {
  ['html', 'css', 'js', 'md'].forEach(lang => {
    currentCode[lang] = localStorage.getItem(`code-${lang}`) || '';
  });
}

    function runCode() {
  const html = currentCode.html || "";
  const css = `<style>${currentCode.css || ""}</style>`;
  const jsCode = (currentCode.js || "").replace(/<\/script>/gi, '<\\/script>');
  const js = `<script>${jsCode}<\/script>`;
  const md = currentCode.md || "";

  previewEl.srcdoc = '';

  if (currentTab === "md") {
    try {
      previewEl.srcdoc = marked.parse(md);
    } catch (error) {
      previewEl.srcdoc = `<pre style="color:red">Error: ${error.message}</pre>`;
    }
    return;
  }

  let finalHtml = html;

  if (finalHtml.includes('</head>')) {
    finalHtml = finalHtml.replace('</head>', `${css}\n</head>`);
  } else {
    finalHtml = `${css}\n${finalHtml}`;
  }

  if (finalHtml.includes('</body>')) {
    finalHtml = finalHtml.replace('</body>', `${js}\n</body>`);
  } else {
    finalHtml += `\n${js}`;
  }

  previewEl.srcdoc = finalHtml;
}


    function toggleTheme() {
      const isLight = document.body.classList.toggle("light");
      if (isLight) {
        themeStyle.href = "https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css";
        localStorage.setItem("theme", "light");
      } else {
        themeStyle.href = "https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.css";
        localStorage.setItem("theme", "dark");
      }
      highlightCurrentElement();
    }

    function saveProject() {
      currentCode[currentTab] = codeEl.innerText;
      localStorage.setItem(`code-${currentTab}`, currentCode[currentTab]);

      const data = {
        html: currentCode.html || "",
        css: currentCode.css || "",
        js: currentCode.js || "",
        md: currentCode.md || ""
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.download = `web-project-${new Date().toISOString().slice(0,10)}.json`;
      link.href = URL.createObjectURL(blob);
      link.click();
      URL.revokeObjectURL(link.href);
    }

 function loadProject(e) {
  const files = Array.from(e.target.files);
  if (!files.length) return;

  const supportedTypes = {
    html: /\.html?$/i,
    css: /\.css$/i,
    js: /\.js$/i,
    md: /\.md$/i,
  };

  let filesLoaded = 0;

  files.forEach(file => {
    const reader = new FileReader();

    reader.onload = (event) => {
      try {
        const content = event.target.result;

        for (const [lang, regex] of Object.entries(supportedTypes)) {
          if (regex.test(file.name)) {
            currentCode[lang] = content;
            localStorage.setItem(`code-${lang}`, content);
            filesLoaded++;
            break;
          }
        }

        if (filesLoaded === files.length) {
          switchTab(currentTab);
          alert("Project loaded successfully!");
        }
      } catch (error) {
        console.error("Error loading project:", error);
        alert(`Error loading project file: ${error.message}`);
      } finally {
        e.target.value = null;
      }
    };

    reader.onerror = () => {
      alert(`Error reading file: ${reader.error}`);
      e.target.value = null;
    };

    reader.readAsText(file);
  });
}


    // --- UI Functions ---
    
    function setupResizeHandle() {
      resizeHandle.addEventListener('mousedown', (e) => {
        isResizing = true;
        lastX = e.clientX;
        lastY = e.clientY;
        document.body.style.cursor = 'col-resize';
        document.addEventListener('mousemove', handleResize);
        document.addEventListener('mouseup', stopResize);
      });
    }
    
    function handleResize(e) {
      if (!isResizing) return;
      
      const container = document.querySelector('.app-container');
      const preview = document.querySelector('.preview-container');
      const editor = document.querySelector('.editor-container');
      
      const dx = e.clientX - lastX;
      const previewWidth = preview.offsetWidth;
      const newPreviewWidth = previewWidth + dx;
      
      // Set minimum and maximum widths
      const minWidth = 200;
      const maxWidth = container.offsetWidth - 200;
      
      if (newPreviewWidth >= minWidth && newPreviewWidth <= maxWidth) {
        preview.style.flex = '0 0 ' + newPreviewWidth + 'px';
        editor.style.flex = '1 1 auto';
      }
      
      lastX = e.clientX;
      lastY = e.clientY;
    }
    
    function stopResize() {
      isResizing = false;
      document.body.style.cursor = '';
      document.removeEventListener('mousemove', handleResize);
      document.removeEventListener('mouseup', stopResize);
    }
    
    function updateCursorPosition() {
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      
      const range = selection.getRangeAt(0);
      const preNode = codeEl;
      const content = preNode.textContent;
      const offset = range.startOffset;
      
      // Calculate line and column
      const textUpToCursor = content.substring(0, offset);
      const lines = textUpToCursor.split('\n');
      const lineNumber = lines.length;
      const columnNumber = lines[lines.length - 1].length + 1;
      
      lineColDisplay.textContent = `Ln ${lineNumber}, Col ${columnNumber}`;
    }

    // --- Helper Functions ---

    function detectColorCode() {
        const sel = window.getSelection();
        if (!sel.rangeCount) return;

        const range = sel.getRangeAt(0);
        const node = range.startContainer;
        const offset = range.startOffset;

        if (node.nodeType !== Node.TEXT_NODE) {
            hideColorPicker();
            return;
        }

        const text = node.textContent;
        let start = offset;
        let end = offset;

        while (start > 0 && /[#0-9a-fA-F]/.test(text[start - 1])) {
            start--;
        }
        while (end < text.length && /[0-9a-fA-F]/.test(text[end])) {
            end++;
        }

        const potentialColor = text.substring(start, end);
        const match = /^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/i.exec(potentialColor);

        if (match) {
            const colorRange = document.createRange();
            colorRange.setStart(node, start);
            colorRange.setEnd(node, end);

            const rect = colorRange.getBoundingClientRect();

            colorPicker.style.left = `${rect.left + window.scrollX}px`;
            colorPicker.style.top = `${rect.bottom + window.scrollY + 5}px`;
            colorPicker.value = match[0];
            colorPicker.style.display = "block";

            colorPickerTargetRange = colorRange;
        } else {
            hideColorPicker();
        }
    }

    function applyColor() {
        if (!colorPickerTargetRange) return;

        const newColor = colorPicker.value;
        const textNode = document.createTextNode(newColor);

        colorPickerTargetRange.deleteContents();
        colorPickerTargetRange.insertNode(textNode);

        const sel = window.getSelection();
        const newRange = document.createRange();
        newRange.setStartAfter(textNode);
        newRange.collapse(true);
        sel.removeAllRanges();
        sel.addRange(newRange);

        handleInput();
        hideColorPicker();
        codeEl.focus();
    }

    function hideColorPicker() {
        if (colorPicker.style.display !== 'none') {
           colorPicker.style.display = "none";
           colorPickerTargetRange = null;
        }
    }

    function showSuggestions() {
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        const range = sel.getRangeAt(0);

        const node = range.startContainer;
        const caretOffset = range.startOffset;

        if (node.nodeType !== Node.TEXT_NODE) {
            hideSuggestions();
            return;
        }

        const text = node.textContent.slice(0, caretOffset);
        const match = text.match(/[\w-$]+$/);
        const lastWord = match ? match[0] : '';

        if (!lastWord || lastWord.length < 1) {
            hideSuggestions();
            return;
        }

        const list = keywords[currentTab] || [];
        const filtered = list.filter(k => k.toLowerCase().startsWith(lastWord.toLowerCase()) && k !== lastWord);

        if (filtered.length === 0) {
            hideSuggestions();
            return;
        }

        suggestionsBox.innerHTML = "";
        filtered.forEach((word, index) => {
            const div = document.createElement("div");
            div.textContent = word;
            div.onclick = (e) => {
                e.stopPropagation();
                insertSuggestion(word, lastWord);
            };
            suggestionsBox.appendChild(div);
            if (index === 0) {
                div.classList.add("selected");
            }
        });

        const rect = range.getBoundingClientRect();
        suggestionsBox.style.left = `${rect.left + window.scrollX}px`;
        suggestionsBox.style.top = `${rect.bottom + window.scrollY + 5}px`;
        suggestionsBox.style.display = "block";
    }

    function hideSuggestions() {
        setTimeout(() => {
            if (suggestionsBox.style.display !== 'none') {
                suggestionsBox.style.display = "none";
                suggestionsBox.innerHTML = "";
            }
        }, 150);
    }

    function insertSuggestion(word, partial) {
        const sel = window.getSelection();
        if (!sel.rangeCount) return;

        const range = sel.getRangeAt(0);
        const node = range.startContainer;
        const offset = range.startOffset;

        if (node.nodeType !== Node.TEXT_NODE) return;

        const replaceRange = document.createRange();
        replaceRange.setStart(node, offset - partial.length);
        replaceRange.setEnd(node, offset);

        replaceRange.deleteContents();
        const textNode = document.createTextNode(word);
        replaceRange.insertNode(textNode);

        range.setStartAfter(textNode);
        range.collapse(true);
        sel.removeAllRanges();
        sel.addRange(range);

        hideSuggestions();
        handleInput();
        codeEl.focus();
    }
  </script>
</body>
</html>